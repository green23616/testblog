# Debug RLS Issue

## Current Situation
- SQL policies were created successfully (they exist)
- But still getting: "new row violates row-level security policy"
- This means policies exist but aren't working correctly

## Let's Check the Policies

### Step 1: Verify Policies in Supabase Dashboard

1. Go to your Supabase Dashboard
2. Click **"Authentication"** in left sidebar
3. Click **"Policies"** tab
4. Find the **"posts"** table
5. You should see these policies:
   - ✅ "Public posts viewable" (SELECT)
   - ✅ "Anyone can update view count" (UPDATE)
   - ✅ "Allow all insert on posts" (INSERT) ← NEW
   - ✅ "Allow all update on posts" (UPDATE) ← NEW
   - ✅ "Allow all delete on posts" (DELETE) ← NEW

### Step 2: Check if RLS is Enabled

In the same Policies view:
- Look for "Enable RLS" toggle
- It should be **ON** (enabled)
- If it's OFF, that's actually fine - turn it ON and the policies will work

### Step 3: Test the Policy Manually

Let's test if the policy actually works by trying to insert directly in SQL Editor:

```sql
-- Test INSERT
INSERT INTO posts (slug, title, content, published)
VALUES ('test-post-manual', 'Manual Test Post', 'This is test content', false);
```

If this works, the policy is fine. If it fails, the policy has an issue.

## Possible Issues

### Issue 1: Service Role Key vs Anon Key
The app might be using the wrong key. Let me check...

Check your `.env.local`:
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - This is used by the app
- `SUPABASE_SERVICE_ROLE_KEY` - This bypasses RLS

The server actions use the **anon key** through the server client, which should respect RLS policies.

### Issue 2: Policy Conflict
There might be a conflict with the existing "Anyone can update view count" policy.

Let's drop the old update policy and keep only our new one:

```sql
-- Drop old update policy
DROP POLICY "Anyone can update view count" ON posts;
```

Then the "Allow all update on posts" policy will be the only UPDATE policy.

### Issue 3: Policy Not Applied Yet
Sometimes Supabase needs a moment to apply policies. Try:
1. Close your browser tab
2. Wait 10 seconds
3. Open fresh tab
4. Try creating a post again

## Let Me Know

Please try:
1. **First**: Test the manual INSERT SQL above in SQL Editor
2. Tell me if it works or fails
3. If it fails with the same RLS error, we have a policy problem
4. If it succeeds, we have an app configuration problem

What happens when you run that manual INSERT?

# Phase 5.1: Image Upload Validation Fix

**Date**: December 12, 2025
**Commit**: 6db0b8b

## Issue

After implementing Phase 5, images uploaded successfully to Supabase Storage but did not display on blog posts.

**Symptoms**:
- Image visible in Supabase Storage bucket
- Image URL correct: `https://khppoakbksbboomlknqc.supabase.co/storage/v1/object/public/blog-images/...`
- Database query returned no rows: `SELECT featured_image FROM posts WHERE featured_image IS NOT NULL`
- Images not showing on blog post pages

## Root Cause

The `postSchema` validation in `src/lib/validations/schemas.ts` was missing `featured_image` and `featured_image_alt` fields.

**Flow**:
1. ✅ User uploads image → Supabase Storage (success)
2. ✅ ImageUploader gets public URL
3. ✅ PostForm state updated with URL
4. ❌ **Form submission → postSchema validation strips out unknown fields**
5. ❌ Server Action receives form data WITHOUT image fields
6. ❌ Database INSERT/UPDATE missing image URL
7. ❌ Blog posts don't display images

**The Problem**:
```typescript
// OLD - Missing image fields
export const postSchema = z.object({
  title: z.string().min(1, 'Title is required'),
  slug: z.string().min(1, 'Slug is required'),
  content: z.string().min(10, 'Content must be at least 10 characters'),
  // ... other fields
  og_image: z.string().url().optional(),
  tag_ids: z.array(z.string().uuid()).optional(),
  // ❌ featured_image NOT HERE - gets stripped during validation
  // ❌ featured_image_alt NOT HERE - gets stripped during validation
})
```

## Solution

Added `featured_image` and `featured_image_alt` to the validation schema:

```typescript
// NEW - Includes image fields
export const postSchema = z.object({
  // ... existing fields
  og_image: z.string().url('Invalid image URL').optional().or(z.literal('')).transform(val => val || null),
  featured_image: z.string().url('Invalid image URL').optional().or(z.literal('')).transform(val => val || null),
  featured_image_alt: z.string().max(200, 'Alt text is too long').optional().or(z.literal('')).transform(val => val || null),
  tag_ids: z.array(z.string().uuid()).optional(),
})
```

**Validation Rules**:
- `featured_image`: Optional URL with validation, transforms empty string to null
- `featured_image_alt`: Optional text, max 200 characters, transforms empty string to null

## Additional Fix

Updated `next.config.js` to use specific hostname instead of wildcard:

```javascript
// OLD - Wildcard pattern
hostname: '*.supabase.co',

// NEW - Specific hostname (more reliable)
hostname: 'khppoakbksbboomlknqc.supabase.co',
```

This ensures Next.js Image component properly optimizes images from the exact Supabase project.

## Files Modified

- `src/lib/validations/schemas.ts` - Added featured_image fields to postSchema
- `next.config.js` - Specific Supabase hostname
- `supabase/verify-storage-setup.sql` - Created verification script
- `documents/5. Phase 5_1_IMAGE_VALIDATION_FIX.md` - This documentation

## Verification

After fix:
1. Upload image in admin panel
2. Query database:
```sql
SELECT id, title, featured_image, featured_image_alt
FROM posts
WHERE featured_image IS NOT NULL;
```
3. Result: ✅ Row returned with image URL
4. Visit blog post: ✅ Image displays

## Lessons Learned

### Validation Schema Completeness
- **Issue**: Easy to forget updating validation schemas when adding new database columns
- **Impact**: Silent data loss (form fields stripped without error)
- **Prevention**:
  - Check validation schema when adding new form fields
  - Add TypeScript type checking between form state and schema
  - Test full data flow: form → validation → database → display

### Development Workflow
- **Pattern Identified**: Database schema changes require updates in multiple places:
  1. Database migration (ALTER TABLE)
  2. TypeScript types (database.ts)
  3. Validation schemas (schemas.ts)
  4. Form components (state management)
  5. Server Actions (if special handling needed)

### Debugging Strategy
- **Effective**: Check each step of data flow
  - ✅ Storage upload (Supabase dashboard)
  - ✅ Form state (React DevTools)
  - ❌ Database (SQL query) ← **Found the gap here**
  - Display (browser)
- **Key Insight**: "Image in bucket but not in database" immediately pointed to validation/submission issue

## Testing Checklist

After fix:
- [x] Image uploads to Supabase Storage
- [x] Image URL saved to database
- [x] Featured image displays on blog post page
- [x] Thumbnail displays on blog list page
- [x] Alt text saves and displays correctly
- [x] Dark mode styling works
- [x] Next.js Image optimization active
- [x] Build succeeds without errors

---

**Status**: ✅ Fixed and verified
**User Confirmation**: "issue resolved"
